<%- include("../layout/layoutTop", {title: title}) %>
<%- include("../layout/menu", {additionalStyles: "", isAuthenticated}) %>

<div class="d-flex flex-column pt-3" style='height: 100%;overflow: hidden'>
    <div class="card mb-3">
        <img src='<%= book.fileCover %>' class="card-img-top" alt="books label" style="height: 60vh;object-fit: cover;object-position: center">
        <div class="card-body">
            <h2 class="card-title"><%= book.title %></h2>
            <p class="card-text"> <%= book.description %> </p>
            <p class="card-text"><small class="text-muted"> <%= book.authors %> </small></p>
            <hr />
            <a href="/books/<%= book._id %>/edit" class="btn btn-secondary" role="button">Изменить книгу</a>
        </div>
    </div>

    <div class="card card_type_chat">
        <div class="card-body">
            <div class="row">
                    <div id="chat" class="list-group list-group-flush">

                    </div>
            </div>
            <hr />
            <% if (isAuthenticated) { %>
                <form id='msg-form'>
                    <div class="d-flex w-100 align-items-center" style='gap:10px'>
                        <div class="form-group w-100 d-flex  align-items-center" style='gap:10px'>
                            <label for="text">Сообщение:</label>
                            <input
                                    placeholder="сообщение"
                                    class="form-control"
                                    id="text"
                                    required
                            />
                        </div>
                        <button type="submit" id="send-message" class="btn btn-primary">Отправить</button>
                    </div>
                </form>
            <%  } else { %>
                <h5>Войдите в учетную запись, чтобы отправлять сообщения</h5>
            <%  } %>
        </div>
    </div>
</div>

<script>
  const socket = io.connect('/', {query: "roomName=<%= book._id %>"});

  const boxList = document.querySelector('#chat');
  const inputText = document.querySelector('#text');
  const sendRoom  = document.querySelector('#send-message');
  const form = document.querySelector('#msg-form');
  const username = "<%= user ? user.username : "" %>"

  const msgLayout = (msg) => {
    const date = new Date();

    return `
      <div class="list-group-item chat-message">
        <p class="card-text"><small class="text-muted">${msg.username} - ${date.toUTCString()}</small></p>
        <p class="mb-1">${msg.text}</p>
      </div>
    `;
  };

  socket.on('message', (msg) => {
    const div = msgLayout(msg);
    boxList.insertAdjacentHTML('beforeend', div);
    boxList.scrollTop = boxList.scrollHeight;
  });

  form.addEventListener('submit', (event) => {
    event.preventDefault();

    socket.emit('message', {
      username,
      text: inputText.value,
    })

    form.reset();
  })


</script>

<%- include("../layout/layoutEnd") %>
